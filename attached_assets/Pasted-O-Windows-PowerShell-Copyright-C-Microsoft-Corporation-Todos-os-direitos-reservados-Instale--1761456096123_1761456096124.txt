O Windows PowerShell
Copyright (C) Microsoft Corporation. Todos os direitos reservados.

Instale o PowerShell mais recente para obter novos recursos e aprimoramentos! https://aka.ms/PSWindows

PS C:\Users\joao lucas> ssh root@72.61.217.143
root@72.61.217.143's password:
Welcome to Ubuntu 24.04.3 LTS (GNU/Linux 6.8.0-85-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

 System information as of Sun Oct 26 05:20:44 UTC 2025

  System load:  1.87                Processes:             151
  Usage of /:   29.5% of 192.69GB   Users logged in:       1
  Memory usage: 7%                  IPv4 address for eth0: 72.61.217.143
  Swap usage:   0%                  IPv6 address for eth0: 2a02:4780:66:1d0d::1

 * Strictly confined Kubernetes makes edge and IoT secure. Learn how MicroK8s
   just raised the bar for easy, resilient and secure K8s cluster deployment.

   https://ubuntu.com/engage/secure-kubernetes-at-the-edge

Expanded Security Maintenance for Applications is not enabled.

0 updates can be applied immediately.

Enable ESM Apps to receive additional future security updates.
See https://ubuntu.com/esm or run: sudo pro status


1 updates could not be installed automatically. For more details,
see /var/log/unattended-upgrades/unattended-upgrades.log

*** System restart required ***
Last login: Sun Oct 26 03:58:40 2025 from 201.89.65.228
root@srv1080561:~# docker exec -it cnpj_postgres psql -U cnpj_user -d cnpj_db
psql (16.10)
Type "help" for help.

cnpj_db=#
cnpj_db=# \timing on
Timing is on.
cnpj_db=#
cnpj_db=# SELECT
cnpj_db-#     'INÍCIO DA OTIMIZAÇÃO (ZERO DOWNTIME)' as status,
cnpj_db-#     pg_size_pretty(pg_database_size('cnpj_db')) as tamanho_db,
cnpj_db-#     NOW() as inicio;
g_trgm;
CREATE EXTENSION IF NOT EXISTS btree_gin;

SELECT 'Passo 1: Extensões verificadas' as status;

SELECT
    indexname,
    pg_size_pretty(pg_relation_size(indexname::regclass)) as tamanho
FROM pg_indexes
WHERE indexname IN ('idx_estabelecimentos_cnpj_basico', 'idx_estabelecimentos_uf_situacao')
AND schemaname = 'public';

DROP INDEX IF EXISTS idx_estabelecimentos_cnpj_basico;
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_estabelecimentos_cnpj_basico
ON estabelecimentos(cnpj_basico);

DROP INDEX IF EXISTS idx_estabelecimentos_uf_situacao;
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_estabelecimentos_uf_situacao
ON estabelecimentos(uf, situacao_cadastral);

SELECT 'Passo 2: Índices base corrigidos (se necessário)' as status;

SELECT 'Passo 3: Criando MATERIALIZED VIEW temporária (30-60min, API continua funcionando!)...' as status;

DROP MATERIALIZED VIEW IF EXISTS vw_estabelecimentos_completos_new;

CREATE MATERIALIZED VIEW vw_estabelecimentos_completos_new AS
SELECT
    e.cnpj_completo,
    e.identificador_matriz_filial,
    emp.razao_social,
    e.nome_fantasia,
    e.situacao_cadastral,
    e.data_situacao_cadastral,
    msc.descricao as motivo_situacao_cadastral_desc,
    e.data_inicio_atividade,
    e.cnae_fiscal_principal,
    e.cnae_fiscal_secundaria,
    cnae.descricao as cnae_principal_desc,
    e.tipo_logradouro,
    e.logradouro,
    e.numero,
    e.complemento,
    e.bairro,
    e.cep,
    e.uf,
    mun.descricao as municipio_desc,
    e.ddd_1,
    e.telefone_1,
    e.correio_eletronico,
    emp.natureza_juridica,
    nj.descricao as natureza_juridica_desc,
    emp.porte_empresa,
    emp.capital_social,
    emp.ente_federativo_responsavel,
    sn.opcao_simples,
    sn.opcao_mei
FROM estabelecimentos e
INNER JOIN empresas emp ON e.cnpj_basico = emp.cnpj_basico
LEFT JOIN cnaes cnae ON e.cnae_fiscal_principal = cnae.codigo
LEFT JOIN municipios mun ON e.municipio = mun.codigo
LEFT JOIN motivos_situacao_cadastral msc ON e.motivo_situacao_cadastral = msc.codigo
LEFT JOIN naturezas_juridicas nj ON emp.natureza_juridica = nj.codigo
LEFT JOIN simples_nacional sn ON e.cnpj_basico = sn.cnpj_basico;

SELECT
    'Passo 3: MATERIALIZED VIEW temporária criada!' as status,
    pg_size_pretty(pg_total_relation_size('vw_estabelecimentos_completos_new')) as tamanho;

SELECT 'Passo 4: Criando índices (20-30min, API continua funcionando!)...' as status;

CREATE UNIQUE INDEX idx_mv_new_estabelecimentos_cnpj_unique
ON vw_estabelecimentos_completos_new(cnpj_completo);

CREATE INDEX idx_mv_new_estabelecimentos_razao_social
ON vw_estabelecimentos_completos_new(razao_social);

CREATE INDEX idx_mv_new_estabelecimentos_nome_fantasia
ON vw_estabelecimentos_completos_new(nome_fantasia);

CREATE INDEX idx_mv_new_estabelecimentos_uf
ON vw_estabelecimentos_completos_new(uf);

CREATE INDEX idx_mv_new_estabelecimentos_situacao
ON vw_estabelecimentos_compl                status                | tamanho_db |            inicio
--------------------------------------+------------+-------------------------------
 INÍCIO DA OTIMIZAÇÃO (ZERO DOWNTIME) | 50 GB      | 2025-10-26 05:21:15.085922+00
(1 row)

Time: 14.952 ms
cnpj_db=#
cnpj_db=# CREATE EXTENSION IF NOT EXISTS pg_trgm;
etos_new(situacao_cadastral);

CREATE INDEX idx_mv_new_estabelecimentos_cnae
ON vw_estabelecimentos_completos_new(cnae_fiscal_principal);

CREATE INDEX idx_mv_new_estabelecimentos_municipio
ON vw_estabelecimentos_completos_new(municipio_desc);

CREATE INDEX idx_mv_new_estabelecimentos_uf_situacao
ON vw_estabelecimentos_completos_new(uf, situacao_cadastral);

CREATE INDEX idx_mv_new_estabelecimentos_razao_social_trgm
ON vw_estabelecimentos_completos_new USING gin(razao_socNOTICE:  extension "pg_trgm" already exists, skipping
CREATE EXTENSION
Time: 2.992 ms
cnpj_db=# CREATE EXTENSION IF NOT EXISTS btree_gin;
NOTICE:  extension "btree_gin" already exists, skipping
CREATE EXTENSION
Time: 0.302 ms
ial gin_trgm_ops);

CREATE INDEX idx_mv_new_estabelecimentos_nome_fantasia_trgm
ON vw_estabeleccnpj_db=#
cnpj_db=# SELECT 'Passo 1: Extensões verificadas' as status;
             status
--------------------------------
 Passo 1: Extensões verificadas
(1 row)

Time: 0.196 ms
cnpj_db=#
cnpj_db=# SELECT
cnpj_db-#     indexname,
cnpj_db-#     pg_size_pretty(pg_relation_size(indexname::regclass)) as tamanho
cnpj_db-# FROM pg_indexes
cnpj_db-# WHERE indexname IN ('idx_estabelecimentos_cnpj_basico', 'idx_estabelecimentos_uf_situacao')
cnpj_db-# AND schemaname = 'public';
imentos_completos_new USING gin(nome_fantasia gin_trgm_ops);

SELECT 'Passo 4: Todos os índices criados!' as status;

ANALYZE vw_estabelecimentos_completos_new;

SELECT 'Passo 5: Estatísticas atualizadas' as status;

SELECT 'Passo 6: Preparando swap atômico...' as status;

BEGIN;

DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM pg_views WHERE viewname = 'vw_estabelecimentos_completos') THEN
        DROP VIEW IF EXISTS vw_estabelecimentos_completos_old CASCADE;
        ALTER VIEW vw_estabelecimentos_completos RENAME TO vw_estabelecimentos_completos_old;
    END IF;

    IF EXISTS (SELECT 1 FROM pg_matviews WHERE matviewname = 'vw_estabelecimentos_completos') THEN
        DROP MATERIALIZED VIEW IF EXISTS vw_estabelecimentos_completos_old;
        ALTER MATERIALIZED VIEW vw_estabelecimentos_completos RENAME TO vw_estabelecimentos_completos_old;
    END IF;
END $$;

DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM pg_matviews WHERE matviewname = 'v            indexname             | tamanho
----------------------------------+---------
 idx_estabelecimentos_cnpj_basico | 1402 MB
 idx_estabelecimentos_uf_situacao | 317 MB
(2 rows)

Time: 26.526 ms
cnpj_db=#
cnpj_db=# DROP INDEX IF EXISTS idx_estabelecimentos_cnpj_basico;
_estabelecimentos_completos_old') THEN
        ALTER INDROP I