# ========================================
# COMANDOS PARA COPIAR E COLAR NA VPS
# ========================================
# Execute os comandos abaixo UM POR VEZ
# Copie e cole diretamente no terminal da VPS
# ========================================

# ===== TAREFA 1: REFRESH AUTOMÁTICO =====

# 1. Criar script de refresh
cat > /root/refresh_view.sh << 'EOF'
#!/bin/bash
echo "[$(date)] Iniciando refresh da MATERIALIZED VIEW..."
docker exec -i cnpj_postgres psql -U cnpj_user -d cnpj_db -c "REFRESH MATERIALIZED VIEW CONCURRENTLY vw_estabelecimentos_completos;"
if [ $? -eq 0 ]; then
    echo "[$(date)] Refresh concluído com sucesso!"
else
    echo "[$(date)] ERRO no refresh!"
fi
EOF

# 2. Dar permissão de execução
chmod +x /root/refresh_view.sh

# 3. Testar manualmente (vai demorar alguns minutos)
/root/refresh_view.sh

# 4. Configurar cron (abrir editor)
crontab -e
# ⚠️ Se perguntar qual editor, escolha "nano" (opção 1)
# ⚠️ Adicione esta linha no final do arquivo:
# 0 3 * * * /root/refresh_view.sh >> /var/log/refresh_view.log 2>&1
# ⚠️ Salve: Ctrl+O, Enter, Ctrl+X

# 5. Verificar se cron foi salvo
crontab -l


# ===== TAREFA 2: OTIMIZAR POSTGRESQL =====

# 1. Aplicar configurações PostgreSQL
docker exec -i cnpj_postgres psql -U cnpj_user -d cnpj_db << 'EOF'
ALTER SYSTEM SET shared_buffers = '4GB';
ALTER SYSTEM SET effective_cache_size = '12GB';
ALTER SYSTEM SET work_mem = '40MB';
ALTER SYSTEM SET maintenance_work_mem = '1600MB';
ALTER SYSTEM SET max_worker_processes = 4;
ALTER SYSTEM SET max_parallel_workers = 4;
ALTER SYSTEM SET max_parallel_workers_per_gather = 2;
ALTER SYSTEM SET random_page_cost = 1.1;
ALTER SYSTEM SET effective_io_concurrency = 200;
ALTER SYSTEM SET wal_buffers = '16MB';
ALTER SYSTEM SET max_wal_size = '2GB';
ALTER SYSTEM SET min_wal_size = '1GB';
ALTER SYSTEM SET checkpoint_completion_target = 0.9;
ALTER SYSTEM SET autovacuum_max_workers = 2;
ALTER SYSTEM SET autovacuum_naptime = '1min';
ALTER SYSTEM SET log_min_duration_statement = 1000;
ALTER SYSTEM SET log_checkpoints = on;
SELECT 'Configurações aplicadas!' as status;
EOF

# 2. Reiniciar PostgreSQL
docker restart cnpj_postgres

# 3. Aguardar PostgreSQL iniciar
sleep 30

# 4. Verificar configurações
docker exec -i cnpj_postgres psql -U cnpj_user -d cnpj_db << 'EOF'
SELECT name, setting, unit 
FROM pg_settings 
WHERE name IN ('shared_buffers', 'effective_cache_size', 'work_mem', 'max_worker_processes')
ORDER BY name;
EOF


# ===== TAREFA 3 (OPCIONAL): INSTALAR REDIS =====

# 1. Instalar Redis
sudo apt update && sudo apt install -y redis-server

# 2. Habilitar e iniciar
sudo systemctl enable redis-server
sudo systemctl start redis-server

# 3. Testar
redis-cli ping

# 4. Configurar senha (abrir editor)
sudo nano /etc/redis/redis.conf
# ⚠️ Procurar linha: # requirepass foobared
# ⚠️ Descomentar e trocar para: requirepass SUA_SENHA_FORTE
# ⚠️ Salvar: Ctrl+O, Enter, Ctrl+X

# 5. Reiniciar Redis
sudo systemctl restart redis-server

# 6. Testar com senha
redis-cli -a SUA_SENHA_FORTE ping
